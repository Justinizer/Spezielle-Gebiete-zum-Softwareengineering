<html>
<head>
<meta charset="UTF-8">
<title>SHP</title>
<script src="js/jquery.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load('current', {'packages':['corechart']});

  function drawChart(data, title) {
	data = google.visualization.arrayToDataTable(data);

	var options = {
	  title: title,
	  curveType: 'function',
	  explorer: { axis: 'horizontal', keepInBounds: true, maxZoomIn: 4.0},
	  legend: { position: 'bottom' }
	};

	var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

	chart.draw(data, options);
  }
</script>

<style>
table {
	border-collapse: collapse;
	border: 1px solid black;
}

th, td {
	text-align: left;
	padding: 8px;
	text-align: center;
	vertical-align: middle;
}

tr:nth-child(even) {
	background-color: #f2f2f2
}

tr:hover {
	background-color: #edf7ee
}

.button {
	background-color: #4CAF50; /* Green */
	border: none;
	color: white;
	padding: 7px 15px;
	text-align: center;
	text-decoration: none;
	display: inline-block;
	font-size: 16px;
	margin: 4px 2px;
	cursor: pointer;
	-webkit-transition-duration: 0.4s; /* Safari */
	transition-duration: 0.4s;
}

.button:hover {
	box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0
		rgba(0, 0, 0, 0.19);
}

th {
	background-color: #4CAF50;
	color: white;
}

#tbCondition {
	float:left;
	border: 1px solid black;
	margin-right: 10px;
	margin-bottom: 10px;
}

#tbAction {
	float: left;
	border: 1px solid black;
	margin-bottom: 10px;
}

#content {
	display: none;
}

#sensorTable {
	float: left;
	margin-right: 10px;
	width: 15%;
}

#actorTable {
	float: left;
	border: 1px solid black;
	width: 49%;
}

#configurationTable {
	border: 1px solid black;
}

/* The Modal (background) */
.modal {
	display: none; /* Hidden by default */
	position: fixed; /* Stay in place */
	z-index: 1; /* Sit on top */
	padding-top: 100px; /* Location of the box */
	left: 0;
	top: 0;
	width: 100%; /* Full width */
	height: 100%; /* Full height */
	overflow: auto; /* Enable scroll if needed */
	background-color: rgb(0,0,0); /* Fallback color */
	background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
	background-color: #fefefe;
	margin: auto;
	padding: 20px;
	border: 1px solid #888;
	width: 80%;
}

/* The Close Button */
.close {
	color: #aaaaaa;
	float: right;
	font-size: 28px;
	font-weight: bold;
}

.close:hover,
.close:focus {
	color: #000;
	text-decoration: none;
	cursor: pointer;
}
</style>
</head>
<body>
	<script>
	//var backendip = "127.0.0.1:8080/SHP-Web";
	var backendip = "192.168.1.1:8080/SHP-Web"
	//var backendip = window.location.host  + window.location.pathname;
	var baseUrl ="http://" + backendip + "/rest/gui";
	var conditionRowId = 0;
	var actionRowId = 0;
	var newAutomationId = 0;
	var jsonThings;
	var conditionTypes;
	var savedConditions = 0;
	var conditionsToSave = 0;
	var savedActions = 0;
	var actionsToSave = 0;
	var deleteActionList = [];
	var deleteConditionList = [];
	var combo = $("<select></select>");
	var actors = $("<select></select>");
	var sensors =$("<select></select>");
	var automation;
	
	function onMessage(event){
		var jdata = JSON.parse(event.data);
		var element = document.getElementById('thing' + jdata.id);

		element.innerHTML  = jdata.value;
		element.style.background = "red";

		setTimeout(function() {
			element.style.background = "none";
		}, 2000);

		if(jdata.type == "DigitalActor") {
			if(jdata.value == '1'){
				document.getElementById('btn' + jdata.id).value  = "Ausschalten";
				document.getElementById('btn' + jdata.id).setAttribute( "onClick", "javascript: digitalAction(" + jdata.id + ", 0);" );

			} else {
				document.getElementById('btn' + jdata.id).value  = "Einschalten";	
				document.getElementById('btn' + jdata.id).setAttribute( "onClick", "javascript: digitalAction(" + jdata.id + ", 1);" );
			}

		} else if(jdata.type == "AnalogActor"){
			document.getElementById('analog' + jdata.id).value  = jdata.value;
		}
	}
	
	function connectWS(){
		ws = new WebSocket("ws://" + backendip + "/websocket");	
		ws.onmessage = onMessage;
	}

	function getThings(){
		$.getJSON(baseUrl + "/thing", function(thingsData) {
			jsonThings = thingsData;	
			$.getJSON(baseUrl + "/automation/conditionTypes", function(typeData) {
				conditionTypes = typeData;
				fillTables();
			});		
			
		});
	}

	function digitalAction(id, action) {
		$.post(baseUrl + "/thing", {id:id, value:action}, function(data) {
			if (data.status === "successful") {
				/* yay */
			}
		});
	}

	function analogAction(id) {
		var value = document.getElementById("analog"+id).value;//$('#'+id).val();
		$.post(baseUrl + "/thing", {id:id, value:value}, function(data) {
			if (data.status === "successful") {
				/* yay */
			}
		});
	}

	function getAutomationsAndLinkWithTable() {
		$.getJSON(baseUrl + "/automation", function(data) {
			console.log(data);
			automation = data;

			// Remove all options before appending the new options
			$('#comboAuto').find('option').remove();

			$.each(data, function(ai, auto) {			
				  
				 $('#comboAuto').append($("<option></option>")
								.attr("id","autoid" + auto.id)
								.text(auto.name)); 	
			});

			fillCondtionAndAction();
			$('#comboAuto').change(fillCondtionAndAction);
		});
	}

	function addConditionRow() {
		conditionRowId += 1;

		var row = '<tr class="tbConditionRow" id="conditionRowId' + conditionRowId + '"><td><select>' + sensors.html() + '</select></td><td><select>';
		row += combo.html() + '</select></td>';
		row += '<td><input type="text"></td><td><input type="button" class="button" value="Entfernen" onclick="removeConditionRow(';
		row += conditionRowId + ')"></td></tr>';

		$('#tbCondition tr:last').prev().after(row);
	}

	function addActionRow() {
		actionRowId += 1;

		var row = '<tr class="tbActionRow" id="actionRowId' + actionRowId + '"><td><select>' + actors.html() + '</select></td>';
		row += '<td><input type="text"></td>';
		row += '<td><input type="button" class="button" value="Entfernen" onclick="removeActionRow(' + actionRowId + ')"></td></tr>';

		$('#tbAction tr:last').prev().after(row);
	}

	function removeConditionRow(rowId) {
		if ($('#conditionRowId' + rowId).find('td:nth-child(1)').attr('id') && $('#conditionRowId' + rowId).find('td:nth-child(1)').attr('id').startsWith('conditionNameTD')) {
			var conditionIdString = $('#conditionRowId' + rowId).find('td:nth-child(1)').attr('id');
			var conditionId = conditionIdString.replace('conditionNameTD', '');
			var condition = {};

			var selectedIndex = document.getElementById("comboAuto").selectedIndex;
			var options = document.getElementById("comboAuto").options;
			var selectedAutomation = getAutomationById(options[selectedIndex].id.replace('autoid', ''));

			for (var i = 0; i < selectedAutomation.conditions.length; i++) {
				if (selectedAutomation.conditions[i].id == conditionId) {
					condition = selectedAutomation.conditions[i];
					break;
				}
			}

			deleteConditionList.push(condition);
		}

		$('#conditionRowId' + rowId).remove();
	}

	function removeActionRow(rowId) {
		if ($('#actionRowId' + rowId).find('td:nth-child(1)').attr('id') && $('#actionRowId' + rowId).find('td:nth-child(1)').attr('id').startsWith('actionNameTD')) {
			var actionIdString = $('#actionRowId' + rowId).find('td:nth-child(1)').attr('id');
			var actionId = actionIdString.replace('actionNameTD', '');
			var action = {};

			var selectedIndex = document.getElementById("comboAuto").selectedIndex;
			var options = document.getElementById("comboAuto").options;
			var selectedAutomation = getAutomationById(options[selectedIndex].id.replace('autoid', ''));

			for (var i = 0; i < selectedAutomation.actions.length; i++) {
				if (selectedAutomation.actions[i].id == actionId) {
					action = selectedAutomation.actions[i];
					break;
				}
			}

			deleteActionList.push(action);
		}

		$('#actionRowId' + rowId).remove();
	}

	function fillCondtionAndAction(){
		var x = document.getElementById("comboAuto").selectedIndex;
		var y = document.getElementById("comboAuto").options;
		var selectedAuto;
		var selectedid =  y[x].id;

		if (selectedid) {
			$.each(automation, function(ai, auto) {
				if(("autoid" + auto.id) === selectedid){
					selectedAuto = auto;		
				}
			});

		} else {
			for (var i = 0; i < automation.length; i++) {
				if (automation[i].id === y[x].value) {
					selectedAuto = automation[i];
					break;
				}
			}
		}

		$(".tbConditionRow").remove(); 		
		$(".tbActionRow").remove(); 

		$('#automationNameField').val(selectedAuto.name);
		$('#automationActivated').prop('checked', selectedAuto.active);

		deleteConditionList = [];
		deleteActionList = [];

		$.each(selectedAuto.conditions, function(ci, condi) {
			var conditionid = condi.id;
			$('#tbCondition tr:last').prev().after(
					'<tr class="tbConditionRow" id="conditionRowId' + conditionRowId + '"><td id="conditionNameTD' + conditionid + '"><select id="conditionThing' + conditionid + '">' + sensors.html() + "</select></td>" + 
					"<td><select id='select" + conditionid + "'>" + combo.html() + "</select></td>" + 
					"<td><input id='condiValue" + conditionid + "' type='text' value='" +condi.value + "'/></td>" +
					'<td><input type="button" class="button" value="Entfernen" onclick="removeConditionRow(' + conditionRowId + ')"></td></tr>' );

			$("#select" + conditionid  + " :nth-child(" +  (condi.type +1) + ")").prop('selected', true);				
			$("#conditionThing" + conditionid + " option[value=" + condi.thing  +"]").prop('selected', true);

			conditionRowId += 1;
		});

		
		$.each(selectedAuto.actions, function(ai, action) {
			var actionid = action.id;
			$('#tbAction tr:last').prev().after(
					'<tr class="tbActionRow" id="actionRowId' + actionRowId + '"><td id="actionNameTD' + actionid + '"><select id="actionThing' + actionid +
					'">' + actors.html() + "</select></td>" + 
					"<td><input id='actionValue" + actionid + "' type='text' value='" +action.value + "'/></td>" +
					'<td><input type="button" class="button" value="Entfernen" onclick="removeActionRow(' + actionRowId + ')"></td></tr>' );

			$("#actionThing" + actionid + " option[value=" + action.thing  +"]").prop('selected', true);

			actionRowId += 1;
		});
	
	}

	function fillTables() {
		
		$.each(conditionTypes, function (i, item) {
			combo.append('<option value="' + item.id + '">' + item.info + "</option>");
		});
		
		$.each(jsonThings, function(i, item) {
			if (item.type.endsWith("Actor")) {
				actors.append('<option value="' + item.id + '">' + item.name + '</option>');
			}
		});
		
		$.each(jsonThings, function(i, item) {

			switch(item.type) {
				case "Sensor":
					var unit = (item.unit === undefined) ? "" : item.unit;
					$('#sensorTable tr:last').after('<tr onclick="openPopup(' + item.id + ', \'' + item.name + '\')"><td>' + item.name + '</td><td>' + '<p id=\'thing' + item.id + '\'>' + item.currentValue.value + ' ' + unit + '</p></td></tr>');

					sensors.append('<option value="' + item.id + '">' + item.name + '</option>');
					break;
					
				case "DigitalActor":
					var buttonText = "Ausschalten";
					var value = 0;

					if (item.currentValue.value == 0) {
						value = 1;
						buttonText = "Einschalten";
					}

					$('#actorTable tr:last').after('<tr><td onclick="openPopup(' + item.id + ', \'' + item.name + '\')">' + item.name + '</td><td>' + '<p id=\'thing' + item.id + '\'>' + item.currentValue.value +'</p></td><td><input type="button" class="button" value="' + buttonText + '" onclick="digitalAction(' + item.id + ', ' + value + ')" id="btn'+ item.id +'"></td></tr>');
					break;

				case "AnalogActor":
					$('#actorTable tr:last').after('<tr><td onclick="openPopup(' + item.id + ', \'' + item.name + '\')">' + item.name + '</td><td>' + '<p id=\'thing' + item.id + '\'>' + item.currentValue.value +'</p></td><td><input type="range" min="0" max="100" id="analog' + item.id + '" value="' + item.currentValue.value + '"><input type="button"  class="button" value="Absenden" onclick="analogAction(' + item.id + ')"></td></tr>');
					break;
			}
		});

		getAutomationsAndLinkWithTable();
	}

	function getAutomationById(id) {
		for (var i = 0; i < automation.length; i++) {
			var temp = automation[i].id;
			if (automation[i].id == id) {
				return automation[i];
			}
		}
	}

	function submitChanges() {
		var selectedIndex =  document.getElementById('comboAuto').selectedIndex;
		var options = document.getElementById('comboAuto').options;
		var isNewAutomation = options[selectedIndex].value.startsWith("newAuto");


		var automationObj = {actions: [], active: $('#automationActivated').prop('checked'), conditions: [], name: $('#automationNameField').val()};
		options[selectedIndex].innerHTML = automationObj.name;

		if (!isNewAutomation) {
			var id = options[selectedIndex].id;
			automationObj.id = getAutomationById(id.replace('autoid', '')).id;
		}

		for (var i = 0; i < deleteConditionList.length; i++) {
			$.ajax({url: baseUrl + "/automation/condition/" + deleteConditionList[i].id, type: 'DELETE', success: function(result) {
				console.log(result);
			}});
		}
		deleteConditionList = [];

		for (var i = 0; i < deleteActionList.length; i++) {
			$.ajax({url: baseUrl + "/automation/action/" + deleteActionList[i].id, type: 'DELETE', success: function(result) {
				console.log(result);
			}});
		}
		deleteActionList = [];


		$('.tbConditionRow').each(function(i, row) {
			var thing = $(row).find('td:nth-child(1) select').val();
			var type = $(row).find('td:nth-child(2) select').val();
			var value = $(row).find('td:nth-child(3) input').val();

			var newCond = {thing: thing, type: type, value: value};

			if ($(row).find('td:nth-child(1)').attr('id') && $(row).find('td:nth-child(1)').attr('id').startsWith('conditionNameTD')) {
				var idString = $(row).find('td:nth-child(1)').attr('id');
				newCond.id = idString.replace('conditionNameTD', '');
			}

			automationObj.conditions.push(newCond);
		});


		$('.tbActionRow').each(function(i, row) {
			var thing = $(row).find('td:nth-child(1) select').val();
			var value = $(row).find('td:nth-child(2) input').val();

			var newAction = {thing: thing, value: value};

			if ($(row).find('td:nth-child(1)').attr('id') && $(row).find('td:nth-child(1)').attr('id').startsWith('actionNameTD')) {
				var idString = $(row).find('td:nth-child(1)').attr('id');
				newAction.id = idString.replace('actionNameTD', '');
			}

			automationObj.actions.push(newAction);
		});


		saveAutomation(automationObj);
	}

	function saveAutomation(automationObj) {
		var param = {name:automationObj.name};
		var actionUrl = "/create";

		if ('id' in automationObj) {
			actionUrl = "";
			param.automationid = automationObj.id;
			param.active = automationObj.active;
		}

		$.post(baseUrl + "/automation" + actionUrl, param, function(answer) {
			var newAutoId;

			if ('id' in answer) {
				newAutoId = answer.id;

			} else {
				newAutoId = automationObj.id;
			}

			actionsToSave = automationObj.actions.length;
			for (var i = 0; i < actionsToSave; i++) {
				var action = automationObj.actions[i];
				var actionIdUrl = "";

				param = {name:automationObj.name, value:action.value};


				if ('id' in action) {
					actionIdUrl = "/" + action.id;
					param.thingid = action.thing;

				} else {
					param.autoid = newAutoId;
					param.thing = action.thing;
				}


				$.post(baseUrl + "/automation/action" + actionIdUrl, param, function(manswer) {
					savedActions += 1;
					reloadAutomations();
				});
			}

			conditionsToSave = automationObj.conditions.length;
			for (var i = 0; i < conditionsToSave; i++) {
				var condition = automationObj.conditions[i];
				var conditionIdUrl = "";

				param = {thingid: condition.thing, value: condition.value};


				if ('id' in condition) {
					conditionIdUrl = "/" + condition.id;
					param.conditionType = condition.type;

				} else {
					param.autoid = newAutoId;
					param.type = condition.type;
				}


				$.post(baseUrl + "/automation/condition" + conditionIdUrl, param, function(manswer) {
					savedConditions += 1;
					reloadAutomations();
				});
			}
		});
	}

	function reloadAutomations() {
		if (savedConditions > 0 && savedConditions == conditionsToSave && savedActions > 0 && savedActions == actionsToSave) {
			savedConditions = 0;
			savedActions = 0;

			getAutomationsAndLinkWithTable();
		}
	}

	function addAutomation() {
		$(".tbConditionRow").remove(); 		
		$(".tbActionRow").remove(); 

		$('#automationNameField').val("Neue Regel");
		$('#automationActivated').prop('checked', true);

		$('#comboAuto').append(new Option("Neue Regel", "newAuto" + newAutomationId, false, true));

		automation.push({actions: [], active: false, conditions: [], id: "newAuto" + newAutomationId, name: "Neue Regel"});

		newAutomationId += 1;
	}

	function deleteAutomation(){
		var selectedIndex = document.getElementById('comboAuto').selectedIndex;
		var options = document.getElementById('comboAuto').options;
		var selectedAuto;
		var selectedid =  options[selectedIndex].id;

		if(options[selectedIndex].value.startsWith("newAuto")) {

			// Selected automation was not saved -> Remove locally only
			
			// Remove object from list
			for (var i = 0; i < automation.length; i++) {
				if (automation[i].id === options[selectedIndex].value) {
					automation.splice(i, 1);
					break;
				}
			}

			$('#comboAuto option:selected').remove();

		} else {

			$.each(automation, function(ai, auto) {
				if(("autoid" + auto.id) === selectedid){
					selectedAuto = auto;	
					selectedid = auto.id;
				}
			});

			$.post(baseUrl + "/automation/delete", {automationid:selectedid}, function(data) {
				for (var i = 0; i < automation.length; i++) {
					if (automation[i].id === options[selectedIndex].value) {
						automation.splice(i, 1);
						break;
					}
				}

				console.log('Deleted automation with ID ' + selectedid);
				$('#comboAuto option:selected').remove();
			});
		}

		fillCondtionAndAction();
	}

	function getAndDisplayDataInChart(thingId, name) {
		$.getJSON(baseUrl + '/thing/' + thingId, function(result) {
			console.log(thingId);

			var data = [['Zeit', 'Wert']];

			$.each(result, function(i, item) {
				data.push([new Date(item.time), parseFloat(item.value)]);
			});

			drawChart(data, name);
		});

	}

	function submit() {
		var email = $('#email').val();
		var password = $('#password').val();
		$.getJSON(baseUrl + "/login/" + email + "/" + password, function(data) {
			if (data.status === "successful") {
				$('#loginForm').hide();
				$('#content').show();
				getThings();
				connectWS();
			}
		});
	}
	</script>

	<div id="popup" class="modal">
	<div class="modal-content">
			<span class="close">&times;</span>
			<div id="curve_chart" style="width: 900px; height: 500px"></div>
		</div>
	</div>

	<div id="loginForm">
		<form action="javascript:submit()">
			Benutzername:<br> <input type="text" id="email" name="email" /><br>
			Passwort:<br> <input type="password" id="password"
				name="password" /><br> <input type="submit" class="button"
				value="Anmelden">
		</form>
	</div>

	<div id="content">
		<div id="automation">
			Konfigurierte Automatisierungen: <select id="comboAuto"></select>
			<input type="button" class="button" value="Löschen" onclick="deleteAutomation()">
			<input type="button" class="button" value="Regel hinzufügen" onclick="addAutomation()">
			<input type="button" class="button" value="Änderungen übernehmen" onclick="submitChanges()"><br>
			Name: <input type="text" id="automationNameField"><input type="checkbox" id="automationActivated">Aktiviert<br>
			<div style="margin-top: 10px;">
				<table id="tbCondition">
					<tr>
						<th>Wenn Sensor</th>
						<th>Bedingung</th>
						<th>Wert</th>
						<th></th>
					</tr>
					<tr><td colspan="3"></td><td><input type="button" class="button" value="Hinzufügen" onclick="addConditionRow()"></td></tr>
				</table>

				<table id="tbAction">
					<tr>
						<th>Dann Aktor</th>
						<th>Wert</th>
						<th></th>
					</tr>
					<tr><td colspan="2"></td><td><input type="button" class="button" value="Hinzufügen" onclick="addActionRow()"></td></tr>
				</table>
			</div>
		</div>
		<br>
		<div style="clear:left;">
			<table id="sensorTable">
				<tr>
					<th>Sensor</th>
					<th>Wert</th>
				</tr>
			</table>
			<table id="actorTable">
				<tr>
					<th>Aktor</th>
					<th>Wert</th>
					<th>Aktion</th>
				</tr>
			</table>
		</div>
		<br>
	</div>

	<script>

	var popup = document.getElementById('popup');
	var span = document.getElementsByClassName("close")[0];

	function openPopup(thingId, name) {
		popup.style.display = "block";
		getAndDisplayDataInChart(thingId, name);
	}

	span.onclick = function() {
		popup.style.display = "none";
	}

	window.onclick = function(event) {
		if (event.target == popup) {
			popup.style.display = "none";
		}
	}
	</script>
</body>
</html>
