<html>
<head>
	<meta charset="UTF-8">
	<title>SHP</title>
	<script src="js/jquery.js"></script>
	<!-- <style>
	td {
		text-align: center; 
		vertical-align: middle;
	}
	#sensorTable { 
		float: left;
		border: 1px solid black;
		margin-right: 10px;
		width: 49%;
	}
	#actorTable {
		float: left;
		border: 1px solid black;
		width: 49%;
	}
	#configurationTable {
		border: 1px solid black;
	}
	#content {
		display: none;
	}
	</style> -->
	<style>
table {
    border-collapse: collapse;
}

th, td {
    text-align: left;
    padding: 8px;
    text-align: center; 
	vertical-align: middle;
}

tr:nth-child(even){background-color: #f2f2f2}
tr:hover{background-color:#edf7ee}

.button {
    background-color: #4CAF50; /* Green */
    border: none;
    color: white;
    padding: 7px 15px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
}
.button:hover {
    box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19);
}

th {
    background-color: #4CAF50;
    color: white;
}
	#content {
		display: none;
	}
	
	#sensorTable { 
		float: left;
		border: 1px solid black;
		margin-right: 10px;
		width: 15%;
	}
	#actorTable {
		float: left;
		border: 1px solid black;
		width: 49%;
	}
	#configurationTable {
		border: 1px solid black;
	}
</style>
</head>
<body>
	<script>
	var backendip = "127.0.0.1:8080/SHP-Web"
	var baseUrl ="http://" + backendip + "/rest/gui";
	var jsonThings;
	var conditionTypes;
	
	function onMessage(event){
		//alert(event.data);
		var jdata = JSON.parse(event.data);
		//alert("id = " + 'thing' + jdata.id  +  " value= " + jdata.value);
		document.getElementById('thing' + jdata.id).innerHTML  = jdata.value;

		//todo: abfangen wenn kein aktor!
		if(jdata.type == "DigitalActor") {
			if(jdata.value == '1'){
				document.getElementById('btn' + jdata.id).value  = "Ausschalten";
				document.getElementById('btn' + jdata.id).setAttribute( "onClick", "javascript: digitalAction(" + jdata.id + ", 0);" );
			} else {
				document.getElementById('btn' + jdata.id).value  = "Einschalten";	
				document.getElementById('btn' + jdata.id).setAttribute( "onClick", "javascript: digitalAction(" + jdata.id + ", 1);" );
			}			
		} else if(jdata.type == "AnalogActor"){
			document.getElementById('analog' + jdata.id).value  = jdata.value;
		}
		
		
		
	}
	
	function connectWS(){
		ws = new WebSocket("ws://" + backendip + "/websocket");	
		ws.onmessage = onMessage;
	}

	function getThings(){
		$.getJSON(baseUrl + "/thing", function(thingsData) {
			jsonThings = thingsData;	
			$.getJSON(baseUrl + "/automation/conditionTypes", function(typeData) {
				conditionTypes = typeData;
				fillTables();
			});		
			
		});
	}

	
	
	function digitalAction(id, action) {
		$.post(baseUrl + "/thing", {id:id, value:action}, function(data) {
			if (data.status === "successful") {
				/* setTimeout(function() {
					removeTableRows();
					getThings();
				}, 100); */
			}
		});
	}
	function analogAction(id) {
		var value = document.getElementById("analog"+id).value;//$('#'+id).val();
		$.post(baseUrl + "/thing", {id:id, value:value}, function(data) {
			if (data.status === "successful") {
				/* setTimeout(function() {
					//removeTableRows();
					//getThings();
				}, 100); */
			}
		});
	}



	function getAutomationsAndLinkWithTable() {
		$.getJSON(baseUrl + "/automation", function(data) {
			console.log(data);

			$.each(data, function(i, item) {
				var sensorId = item.conditions[0].thing;

				$('#sensor' + sensorId + 'td:nth-child(2) select').val(getConditionIdFromName(item.conditions[0].thing));
			});
		});
	}

	function getConditionIdFromName(name) {
		jQuery.grep(conditions, function(item) {
			return item.info === name;
		});
	}

	
	function fillTables() {
		var combo = $("<select></select>");
		var actors = $("<select></select>");

		$.each(conditionTypes, function (i, item) {
			combo.append('<option value="' + item.id + '">' + item.info + "</option>");
		});
		
		$.each(jsonThings, function(i, item) {
			if (item.type.endsWith("Actor")) {
				actors.append('<option value="' + item.id + '">' + item.name + '</option>');
			}
		});
		
		$.each(jsonThings, function(i, item) {

			switch(item.type) {
			case "Sensor":
				var unit = (item.unit === undefined) ? "" : item.unit;
				$('#sensorTable tr:last').after('<tr><td>' + item.name + '</td><td>' + '<p id=\'thing' + item.id + '\'>' + item.currentValue.value + ' ' + unit + '</p></td></tr>');
				$('#configurationTable tr:last').after('<tr><td>' + item.name + '</td><td><select>' + combo.html() + '</select></td><td><input type="text"></td><td><select>' + actors.html() + '</select></td><td><input type="text"></td><td><input type="checkbox"></td></tr>');
				break;
				
			case "DigitalActor":
				var buttonText = "Ausschalten";
				var value = 0;
				if (item.currentValue.value == 0) {
					value = 1;
					buttonText = "Einschalten";
				}
				$('#actorTable tr:last').after('<tr><td>' + item.name + '</td><td>' + '<p id=\'thing' + item.id + '\'>' + item.currentValue.value +'</p></td><td><input type="button" class="button" value="' + buttonText + '" onclick="digitalAction(' + item.id + ', ' + value + ')" id="btn'+ item.id +'"></td></tr>');
				break;
			case "AnalogActor":
				$('#actorTable tr:last').after('<tr><td>' + item.name + '</td><td>' + '<p id=\'thing' + item.id + '\'>' + item.currentValue.value +'</p></td><td><input type="range" min="0" max="100" id="analog' + item.id + '" value="' + item.currentValue.value + '"><input type="button"  class="button" value="Absenden" onclick="analogAction(' + item.id + ')"></td></tr>');
				break;
		}
		});

		getAutomationsAndLinkWithTable();
	}
	function submit() {
		var email = $('#email').val();
		var password = $('#password').val();
		$.getJSON(baseUrl + "/login/" + email + "/" + password, function(data) {
			if (data.status === "successful") {
				$('#loginForm').hide();
				$('#content').show();
				getThings();
				connectWS();
			}
		});
	}
	</script>

	<div id="loginForm">
		<form action="javascript:submit()">
			Benutzername:<br>
			<input type="text" id="email" name="email"/><br>
			Passwort:<br>
			<input type="password" id="password" name="password"/><br>
			<input type="submit"  class="button" value="Anmelden">
		</form>
	</div>

	<div id="content">
		<table id="configurationTable">
			<tr><th>Sensor</th><th>Bedingung</th><th>Wert</th><th>Aktor</th><th>Aktion</th><th>Aktiviert</th></tr>
		</table>
		<br>
		<table id="sensorTable">
			<tr><th>Sensor</th><th>Wert</th></tr>
		</table>
		<table id="actorTable">
			<tr><th>Aktor</th><th>Wert</th><th>Aktion</th></tr>
		</table>
	</div>

</body>
</html>
